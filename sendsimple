#!/bin/bash

SOCKET=~/nockchain/.socket/nockchain_npc.sock

echo "========================================"
echo "        Nockchain Send Simple           "
echo "========================================"
echo

# Now prompt inputs below the titles

read -rp $'📤 Enter Sender pubkey:\n' sender
read -rp $'📥 Enter Recipient pubkey:\n' recipient
read -rp $'🎁 Enter Gift amount:\n' gift
read -rp $'💸 Enter Fee amount:\n' fee

total=$((gift + fee))
echo -e "\n➕ Total required: $total\n"

csvfile="notes-${sender}.csv"

echo "📁 Exporting notes CSV (please wait)..."
nockchain-wallet --nockchain-socket "$SOCKET" list-notes-by-pubkey-csv "$sender"

echo -n "⏳ Waiting for CSV file to appear: $csvfile..."
while [ ! -f "$csvfile" ]; do
  sleep 1
done
echo " found."

# Read CSV and select notes with enough assets
selected_notes=()
selected_assets=0
while IFS=',' read -r name_first name_last assets _block_height _source_hash; do
  [[ "$name_first" == "name_first" ]] && continue
  selected_notes+=("$name_first $name_last")
  selected_assets=$((selected_assets + assets))
  if [ "$selected_assets" -ge "$total" ]; then
    break
  fi
done < "$csvfile"

if [ "$selected_assets" -lt "$total" ]; then
  echo "❌ Not enough funds. Found: $selected_assets, needed: $total"
  exit 1
fi

echo "✅ Using notes: ${selected_notes[*]}"

# Build --names argument
names_arg=""
for note in "${selected_notes[@]}"; do
  if [ -n "$names_arg" ]; then
    names_arg+=","
  fi
  names_arg+="[$note]"
done

# Build --recipients argument (index 1 for single recipient)
recipients_arg="[1 $recipient]"

# Ensure txs directory exists
mkdir -p txs

# Tx filename based on first selected note’s last name
txfile="txs/${selected_notes[0]##* }.tx"

echo "🛠️  Creating draft transaction..."
nockchain-wallet --nockchain-socket "$SOCKET" spend \
  --names "$names_arg" \
  --recipients "$recipients_arg" \
  --gifts "$gift" \
  --fee "$fee" \
  
if [ -f "$txfile" ]; then
  echo "✅ Transaction file created: $txfile"

  echo "🚀 Sending transaction..."
  nockchain-wallet --nockchain-socket "$SOCKET" send-tx "$txfile"
  if [ $? -eq 0 ]; then
    echo "✅ Transaction sent successfully!"
  else
    echo "❌ Failed to send transaction."
  fi
else
  echo "❌ Transaction file not found: $txfile"
fi
