#!/bin/bash

set -euo pipefail

SOCKET=~/nockchain/.socket/nockchain_npc.sock
DRAFTS_DIR=./drafts

mkdir -p "$DRAFTS_DIR"

echo -e "ðŸ“¤ Enter \033[1;36mSender\033[0m pubkey:"
read -r sender
echo -e "ðŸ“¥ Enter \033[1;33mRecipient\033[0m pubkey:"
read -r recipient
echo -e "ðŸŽ Enter \033[1;32mGift\033[0m amount:"
read -r gift
echo -e "ðŸ’¸ Enter \033[1;31mFee\033[0m amount:"
read -r fee

# Validate pubkeys length = 88 chars
for key in "$sender" "$recipient"; do
  if [ ${#key} -ne 132 ]; then
    echo "âŒ Error: Invalid pubkey length (${#key}). Must be exactly 132 characters."
    exit 1
  fi
done

# Validate gift and fee are positive integers
if ! [[ "$gift" =~ ^[0-9]+$ ]] || ! [[ "$fee" =~ ^[0-9]+$ ]]; then
  echo "âŒ Error: Gift and fee must be positive integers."
  exit 1
fi

total=$((gift + fee))

echo
echo "âž• Total:     $total"
echo

# Step 1: Export CSV
echo "ðŸ“ Exporting CSV for sender..."
nockchain-wallet --nockchain-socket "$SOCKET" \
  list-notes-by-pubkey-csv --pubkey "$sender"

csv_file="notes-${sender}.csv"
if [ ! -f "$csv_file" ]; then
  echo "âŒ CSV file not found: $csv_file"
  exit 1
fi
echo "âœ… CSV found: $csv_file"

# Step 2: Parse CSV to find suitable note
echo "ðŸ” Finding suitable note with balance >= $total..."

suitable_note=$(awk -F, -v min="$total" '
  NR > 1 && $3 >= min {
    print $1 "," $2 "," $3;
    exit
  }
' "$csv_file")

if [ -z "$suitable_note" ]; then
  echo "âŒ No suitable note found with assets >= $total."
  exit 1
fi

IFS=',' read -r note_first note_last note_amt <<< "$suitable_note"

echo "âœ… Suitable note found:"
echo "   ðŸ”‘ First:  $note_first"
echo "   ðŸ§¾ Last:   $note_last"
echo "   ðŸ’° Amount: $note_amt"
echo

# Step 3: Make draft using simple-spend (auto generates .draft)
echo "ðŸ› ï¸  Making draft..."
nockchain-wallet --nockchain-socket "$SOCKET" \
  simple-spend \
  --names "[${note_first} ${note_last}]" \
  --recipients "[1 ${recipient}]" \
  --gifts "$gift" \
  --fee "$fee"

draft_file="${DRAFTS_DIR}/${note_last}.draft"

if [ ! -f "$draft_file" ]; then
  echo "âŒ Draft not found: $draft_file"
  exit 1
fi
echo "âœ… Draft created: $draft_file"

# Step 4: Sign draft
echo "âœï¸  Signing draft..."
if ! nockchain-wallet --nockchain-socket "$SOCKET" sign-tx --draft "$draft_file"; then
  echo "âŒ Failed to sign draft"
  exit 1
fi
echo "âœ… Draft signed"

# Step 5: Send transaction
echo "ðŸš€ Sending transaction..."
if ! nockchain-wallet --nockchain-socket "$SOCKET" send-tx --draft "$draft_file"; then
  echo "âŒ Failed to send transaction"
  exit 1
fi
echo "âœ… Transaction sent successfully!"

# Optional: Clean up draft file
# rm -f "$draft_file"
