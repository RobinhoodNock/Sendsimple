#!/bin/bash

SOCKET=~/nockchain/.socket/nockchain_npc.sock

echo "========================================"
echo "        Nockchain Send Simple           "
echo "========================================"
echo

# Now prompt inputs below the titles

read -rp $'ğŸ“¤ Enter Sender pubkey:\n' sender
read -rp $'ğŸ“¥ Enter Recipient pubkey:\n' recipient
read -rp $'ğŸ Enter Gift amount:\n' gift
read -rp $'ğŸ’¸ Enter Fee amount:\n' fee

total=$((gift + fee))
echo -e "\nâ• Total required: $total\n"

csvfile="notes-${sender}.csv"

echo "ğŸ“ Exporting notes CSV (please wait)..."
nockchain-wallet --nockchain-socket "$SOCKET" list-notes-by-pubkey-csv "$sender"

echo -n "â³ Waiting for CSV file to appear: $csvfile..."
while [ ! -f "$csvfile" ]; do
  sleep 1
done
echo " found."

# Read CSV and select notes with enough assets
selected_notes=()
selected_assets=0
while IFS=',' read -r name_first name_last assets _block_height _source_hash; do
  [[ "$name_first" == "name_first" ]] && continue
  selected_notes+=("$name_first $name_last")
  selected_assets=$((selected_assets + assets))
  if [ "$selected_assets" -ge "$total" ]; then
    break
  fi
done < "$csvfile"

if [ "$selected_assets" -lt "$total" ]; then
  echo "âŒ Not enough funds. Found: $selected_assets, needed: $total"
  exit 1
fi

echo "âœ… Using notes: ${selected_notes[*]}"

# Build --names argument
names_arg=""
for note in "${selected_notes[@]}"; do
  if [ -n "$names_arg" ]; then
    names_arg+=","
  fi
  names_arg+="[$note]"
done

# Build --recipients argument (index 1 for single recipient)
recipients_arg="[1 $recipient]"

# Ensure txs directory exists
mkdir -p txs

# Tx filename based on first selected noteâ€™s last name
txfile="txs/${selected_notes[0]##* }.tx"

echo "ğŸ› ï¸  Creating draft transaction..."
nockchain-wallet --nockchain-socket "$SOCKET" spend \
  --names "$names_arg" \
  --recipients "$recipients_arg" \
  --gifts "$gift" \
  --fee "$fee" \
  
if [ -f "$txfile" ]; then
  echo "âœ… Transaction file created: $txfile"

  echo "ğŸš€ Sending transaction..."
  nockchain-wallet --nockchain-socket "$SOCKET" send-tx "$txfile"
  if [ $? -eq 0 ]; then
    echo "âœ… Transaction sent successfully!"
  else
    echo "âŒ Failed to send transaction."
  fi
else
  echo "âŒ Transaction file not found: $txfile"
fi
